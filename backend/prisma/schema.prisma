// This is your Prisma schema file
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for authentication and profile
model User {
  id                String    @id @default(uuid())
  email             String    @unique
  passwordHash      String    @map("password_hash")
  name              String?
  company           String?
  role              Role      @default(USER)
  emailVerified     Boolean   @default(false) @map("email_verified")
  emailVerifyToken  String?   @unique @map("email_verify_token")
  resetToken        String?   @unique @map("reset_token")
  resetTokenExpiry  DateTime? @map("reset_token_expiry")
  isActive          Boolean   @default(true) @map("is_active")
  lastLogin         DateTime? @map("last_login")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  calculations      Calculation[]
  teams             TeamMember[]
  ownedTeams        Team[]
  subscription      Subscription?
  apiKeys           ApiKey[]
  analyticsEvents   AnalyticsEvent[]
  refreshTokens     RefreshToken[]
  calculationVersions CalculationVersion[]
  templates         Template[]
  hostedSessions    CollaborationSession[]
  collaborationParticipants CollaborationParticipant[]
  collaborationComments CollaborationComment[]
  aiUsage           AiUsage[]

  @@map("users")
}

// Team model for collaboration
model Team {
  id          String   @id @default(uuid())
  name        String
  ownerId     String   @map("owner_id")
  plan        TeamPlan @default(TEAM)
  seatsLimit  Int      @default(5) @map("seats_limit")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  owner       User         @relation(fields: [ownerId], references: [id])
  members     TeamMember[]
  calculations Calculation[]

  @@map("teams")
}

// Team member junction table
model TeamMember {
  teamId    String   @map("team_id")
  userId    String   @map("user_id")
  role      TeamRole @default(MEMBER)
  joinedAt  DateTime @default(now()) @map("joined_at")

  // Relations
  user User @relation(fields: [userId], references: [id])
  team Team @relation(fields: [teamId], references: [id])

  @@id([teamId, userId])
  @@map("team_members")
}

// Calculation model for storing pricing calculations
model Calculation {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  teamId       String?  @map("team_id")
  name         String
  inputs       Json
  results      Json
  version      Int      @default(1)
  isPublic     Boolean  @default(false) @map("is_public")
  shareToken   String?  @unique @map("share_token")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  user     User                 @relation(fields: [userId], references: [id])
  team     Team?                @relation(fields: [teamId], references: [id])
  versions CalculationVersion[]
  aiInsights AiInsight[]
  collaborationSessions CollaborationSession[]
  aiUsage    AiUsage[]

  @@index([userId])
  @@index([teamId])
  @@index([createdAt])
  @@map("calculations")
}

// Calculation version history
model CalculationVersion {
  id             String   @id @default(uuid())
  calculationId  String   @map("calculation_id")
  version        Int
  inputs         Json
  results        Json
  changedById    String   @map("changed_by_id")
  changeNote     String?  @map("change_note")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  calculation Calculation @relation(fields: [calculationId], references: [id], onDelete: Cascade)
  changedBy   User        @relation(fields: [changedById], references: [id])

  @@unique([calculationId, version])
  @@map("calculation_versions")
}

// Subscription model for Stripe integration
model Subscription {
  id                   String   @id @default(uuid())
  userId               String   @unique @map("user_id")
  stripeSubscriptionId String?  @unique @map("stripe_subscription_id")
  stripeCustomerId     String?  @map("stripe_customer_id")
  plan                 Plan
  status               SubscriptionStatus
  currentPeriodStart   DateTime? @map("current_period_start")
  currentPeriodEnd     DateTime? @map("current_period_end")
  cancelAtPeriodEnd    Boolean  @default(false) @map("cancel_at_period_end")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@map("subscriptions")
}

// API Keys for integrations
model ApiKey {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  keyHash    String    @unique @map("key_hash")
  name       String
  lastUsed   DateTime? @map("last_used")
  usageCount Int       @default(0) @map("usage_count")
  rateLimit  Int       @default(1000) @map("rate_limit")
  expiresAt  DateTime? @map("expires_at")
  isActive   Boolean   @default(true) @map("is_active")
  createdAt  DateTime  @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@map("api_keys")
}

// Analytics Events for tracking
model AnalyticsEvent {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  eventType  String   @map("event_type")
  eventData  Json?    @map("event_data")
  sessionId  String?  @map("session_id")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
  @@map("analytics_events")
}

// Refresh Token model for JWT refresh
model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

// Enums
enum Role {
  USER
  ADMIN
  SUPER_ADMIN
}

enum TeamRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum TeamPlan {
  TEAM
  BUSINESS
  ENTERPRISE
}

enum Plan {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
  TRIALING
  PAUSED
}

// AI Insights Storage
model AiInsight {
  id             String   @id @default(uuid())
  calculationId  String   @map("calculation_id")
  insightType    String   @map("insight_type") // "pricing", "competitive", "market", "optimization"
  prompt         String
  response       String
  confidence     Float    @default(0.8)
  modelVersion   String   @default("gpt-4") @map("model_version")
  tokensUsed     Int      @map("tokens_used")
  cost           Decimal  @db.Decimal(10,4)
  isValid        Boolean  @default(true) @map("is_valid")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  calculation Calculation @relation(fields: [calculationId], references: [id], onDelete: Cascade)

  @@index([calculationId])
  @@index([insightType])
  @@index([createdAt])
  @@map("ai_insights")
}

// Industry Templates and Benchmarks
model Template {
  id           String   @id @default(uuid())
  name         String
  industry     String
  description  String?
  inputs       Json     // Default input values with industry benchmarks
  benchmarks   Json     // Competitive data and market standards
  isPublic     Boolean  @default(true) @map("is_public")
  createdBy    String?  @map("created_by")
  usageCount   Int      @default(0) @map("usage_count")
  tags         String[] // For filtering and search
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  creator User? @relation(fields: [createdBy], references: [id])

  @@index([industry])
  @@index([isPublic])
  @@map("templates")
}

// Real-time Collaboration Sessions
model CollaborationSession {
  id              String   @id @default(uuid())
  calculationId   String   @map("calculation_id")
  hostId          String   @map("host_id")
  isActive        Boolean  @default(true) @map("is_active")
  maxParticipants Int      @default(5) @map("max_participants")
  settings        Json     // Permissions, editing rules, etc.
  sessionState    Json?    @map("session_state") // Current calculation state
  createdAt       DateTime @default(now()) @map("created_at")
  expiresAt       DateTime @map("expires_at")

  // Relations
  calculation  Calculation @relation(fields: [calculationId], references: [id], onDelete: Cascade)
  host         User        @relation(fields: [hostId], references: [id])
  participants CollaborationParticipant[]
  comments     CollaborationComment[]

  @@index([calculationId])
  @@index([isActive])
  @@map("collaboration_sessions")
}

// Collaboration Participants
model CollaborationParticipant {
  sessionId    String   @map("session_id")
  userId       String?  @map("user_id")
  guestName    String?  @map("guest_name")
  socketId     String   @map("socket_id")
  permissions  Json     // What actions they can perform
  cursor       Json?    // Current cursor position for real-time indicators
  joinedAt     DateTime @default(now()) @map("joined_at")
  lastActive   DateTime @default(now()) @map("last_active")

  // Relations
  session CollaborationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User?                @relation(fields: [userId], references: [id])

  @@id([sessionId, socketId])
  @@map("collaboration_participants")
}

// Collaboration Comments and Annotations
model CollaborationComment {
  id        String   @id @default(uuid())
  sessionId String   @map("session_id")
  authorId  String?  @map("author_id")
  content   String
  position  Json?    // UI position/context for the comment
  isResolved Boolean @default(false) @map("is_resolved")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  session CollaborationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  author  User?                @relation(fields: [authorId], references: [id])

  @@index([sessionId])
  @@map("collaboration_comments")
}

// Cache Management for Performance
model CacheEntry {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String   // JSON serialized data
  tags      String[] // For organized invalidation
  expiresAt DateTime @map("expires_at")
  hitCount  Int      @default(0) @map("hit_count")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([key])
  @@index([expiresAt])
  @@index([tags])
  @@map("cache_entries")
}

// Background Job Queue
model BackgroundJob {
  id          String    @id @default(uuid())
  type        String    // "ai_analysis", "report_generation", "email_notification"
  payload     Json
  status      String    @default("pending") // "pending", "processing", "completed", "failed"
  progress    Int       @default(0) // 0-100%
  result      Json?
  error       String?
  attempts    Int       @default(0)
  maxAttempts Int       @default(3) @map("max_attempts")
  priority    Int       @default(5) // 1 (high) to 10 (low)
  scheduledAt DateTime  @default(now()) @map("scheduled_at")
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([type])
  @@index([status])
  @@index([priority])
  @@index([scheduledAt])
  @@map("background_jobs")
}

// AI Usage Tracking for Cost Management
model AiUsage {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  calculationId String?  @map("calculation_id")
  requestType   String   @map("request_type") // "insight", "analysis", "recommendation"
  tokensUsed    Int      @map("tokens_used")
  cost          Decimal  @db.Decimal(10,6)
  model         String   @default("gpt-4")
  responseTime  Int      @map("response_time") // milliseconds
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  user        User         @relation(fields: [userId], references: [id])
  calculation Calculation? @relation(fields: [calculationId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@map("ai_usage")
}